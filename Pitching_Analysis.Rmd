---
title: "Atlanta Braves Pitching Analysis"
author: "Rob Kravec"
date: "12/14/2020"
output: html_document
---

```{r setup, include=FALSE}
# Set global chunk options
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)

# Load libraries
library(tidyverse)
library(vroom)
library(patchwork)
library(ggrepel)
library(ggiraph)
library(htmlwidgets)
```

## Introduction

Read in Statcast data for Braves pitchers from 2017-2020 (including playoffs)

```{r read-merge-data}
# Create function to read in data. Several columns had data types changed in 
# 2020, so we manually assign the data type of our choosing for those columns
read_braves <- function(year) {
  file_name <- paste0("data/Braves_", year, ".csv")
  pitch_data <- vroom(file_name,
                      col_types = c(release_spin_rate = "d",
                                    release_speed = "d",
                                    release_pos_x = "d",
                                    release_pos_y = "d",
                                    release_pos_z = "d",
                                    zone = "d",
                                    pfx_x = "d",
                                    pfx_z = "d",
                                    plate_x = "d",
                                    plate_z = "d",
                                    fielder_2 = "c", fielder_3 = "c",
                                    fielder_4 = "c", fielder_5 = "c",
                                    fielder_6 = "c", fielder_7 = "c",
                                    fielder_8 = "c", fielder_9 = "c",
                                    vx0 = "d", vy0 = "d", vz0 = "d",
                                    ax = "d", ay = "d", az = "d",
                                    sz_top = "d", sz_bot = "d",
                                    effective_speed = "d",
                                    release_extension = "d"
                                    )
                      )
  return(pitch_data)
}

# Read in 2017-2020 data using function
braves_pitch <- map_df(.x = 2017:2020, .f = read_braves)

# Look at summary of output
glimpse(braves_pitch)

# Based on this summary and the glossary, remove deprecated field
braves_pitch <- braves_pitch %>% 
  select(-c(spin_dir, spin_rate_deprecated, break_angle_deprecated, 
            break_length_deprecated, tfs_deprecated, tfs_zulu_deprecated,
            umpire))

# Remove duplicate columns for pitcher and catcher ids
braves_pitch <- braves_pitch %>% 
  select(-c(pitcher...8, fielder_2...42)) %>% 
  rename(pitcher = pitcher...60, fielder_2 = fielder_2...61)
```

The purpose of this project is to ask and answer some interesting questions 
about Atlanta Braves pitching from 2017-2020. We don't have a set agenda per se.
Rather, the project is a success if we uncover some previously unknown insights
and find compelling ways to present them.

*Why the Atlanta Braves?* I wanted to keep the amount of data manageable, so
I elected to focus on my favorite team
*Why 2017-2020?* There is no special significance to this time period. I wanted
to keep the amount of data manageable while still being able to look at
multiple (recent) seasons. 2017-2020 provided a reasonable solution, while
also ensuring that all velocities were measured with a single system (Statcast).
From 2008 to 2016, pitch velocities were measured via PitchF/x

## EDA

### Who threw the most pitches for the Braves in each year?

```{r 1-most-pitches}
# Create data frame that contains top 10 pitch throwers per season
top_pitches <- braves_pitch %>% 
  group_by(game_year) %>% 
  count(player_name) %>% 
  arrange(desc(n)) %>% 
  slice(1:10) %>% 
  rename(pitches = n)

# Write function to generate desired plot for the given year
plot_pitches <- function(year){
  top_pitches %>% 
    filter(game_year == year) %>% 
    ggplot(mapping = aes(x = reorder(player_name, - pitches), y = pitches)) +
    geom_bar(stat = "identity", fill = "red3") +
    labs(y = "Pitches thrown",
         title = paste0(year)) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.major.x = element_blank(),
          axis.text.x = element_text(angle = 30, hjust = 1),
          axis.title.x = element_blank()) 
}

# Create individual plots required to make patchwork plot of pitch leaders
# for 2017-2020
for (i in 2017:2020) {
  plot_name <- paste0("pitch_", i)
  assign(plot_name, plot_pitches(i))
}

# Build patchwork plot
patch_plot <- (pitch_2017 + pitch_2018) / (pitch_2019 + pitch_2020)
patch_plot <- patch_plot + plot_annotation(
  title = "Atlanta Braves leaders in pitches thrown per year",
  theme = theme(plot.title = element_text(hjust = 0.5, size = 20))) 
patch_plot

# Save plot
ggsave(plot = patch_plot, path = "plots/", filename = "total_pitches.png")
```

Normally, in summarizing a pitcher's work for a given season, we tend to think
about inning totals, not pitch totals. We opted for pitch totals here due to the
unique nature of the Statcast data, and I think the results are pretty 
interesting! 

- The turnover on the Braves' pitching staff year-to-year is quite significant!
Of course, we would need to contextualize (relative to other teams) before 
making any meaningful statements about turnover being more or less than average
- We see clear evidence of the Braves' proclivity for bringing in veteran 
pitchers on short contracts: R.A. Dickey, Jaime Garcia, and Bartolo Colon in 
2017, Anibal Sanchez in 2018, Dallas Keuchel in 2019. Cole Hamels is noticeably
absent from the 2020 plot after a shoulder injury (essentially wasting his $18M
one year contract)
- 2020 was a weird season! Likely due to their prominence in the playoffs, Ian
Anderson and Kyle Wright make the top 3 pitch throwers for the Braves. After
those two and Max Fried, we see a slew of relievers. Chris Martin and Mark 
Melancon (two of the highest leverage arms in the bullpen) threw about 400
pitches each and just missed appearing in the 2020 plot

From here, we'll try to leverage the Statcast data for its strengths: individual
pitch-level insights. While it was fun to look at pitch totals across seasons,
summary statistics (which we could easily find elsewhere) would probably provide
more intuitive and meaningful insights.

### Among the most common pitch types, which pitchers have the most pitch movement?

#### Fastballs

&nbsp;

```{r 2-movement-fastballs}
# Prepare dataset
fastballs <- braves_pitch %>% 
  filter(pitch_name %in% c("2-Seam Fastball", "4-Seam Fastball",
                           "Cutter", "Sinker")) %>% 
  group_by(player_name, pitch_name, p_throws) %>% 
  summarise(cnt = n(),
            x_move = median(pfx_x), # Reduce influence of extreme cases with median
            z_move = median(pfx_z),
            velo = median(release_speed)) %>% 
  filter(cnt >= 50) %>% # Remove pitcher / pitch combos with fewer than 50 occurrences
  ungroup() %>% 
  mutate(x_move_mod = ifelse(p_throws == "L", -x_move, x_move),
         x_move_abs = abs(x_move), # Corrects for difference in L vs. R hand pitchers
         total_move = sqrt(x_move ^ 2 + z_move ^ 2) # Define Pythagorean tot movement
         ) %>%  
  group_by(pitch_name) %>% 
  arrange(pitch_name, desc(total_move)) #%>% 
  #slice(1:10)
# Ultimately decided not to filter by total movement for fastballs because vertical
# movement is tricky for fastballs. While it is generally accepted as a positive
# attribute for 4-seam fastballs, the same cannot be said for 2-seam fastballs, 
# cutters, and sinkers. In fact, lower values of vertical movement for 
# 2-seam fastballs and sinkers is likely desirable (e.g., a rising sinker is bad)

# Generate interactive scatterplot using ggirafe
fastball_plot <- ggplot(data = fastballs, 
       mapping = aes(x = x_move_mod, y = z_move)) +
  geom_jitter_interactive(mapping = aes(size = velo,
                                       tooltip = paste0("Player: ", player_name, 
                                                        "\n Avg velo: ",
                                                        round(velo, 1), " MPH"))
                         , color = "red3") +
  labs(x = "Horizontal movement [ft]",
       y = "Vertical movement [ft]",
       title = "Fastball-type pitches with greatest avg movement",
       size = "Velocity [mph]") +
  facet_wrap(~pitch_name) +
  scale_size_continuous(range = c(0.5, 1.5)) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) 

# Save plot as .html file
fastball_plot_interactive <- girafe(code = print(fastball_plot))
withr::with_dir('plots', saveWidget(fastball_plot_interactive,
                                    file="fastball_movement.html"))
# Last command is necessary to save plot into "plots/" directory. saveWidget
# has an issue with relative paths
```

This exercise gave some good practice with interactive plotting and showed the
importance of using intuition during the EDA process. At first, it seemed like
a good idea to use a Pythagorean definition of total movement (i.e., sqrt of
sum of squared x and z movement components) to select pitchers with better
than average movement on their pitches. However, upon reviewing the resulting
filtered scatterplots, it became apparent that something was wrong (due to the
absence of expected names): Some pitches (namely 2-seam fastballs and sinkers)
are actually better if they have less positive z-directional movement. 

To combat this issue, I decided to include all pitchers who threw at least 50
of that pitch type and use interactive points (through ggirafe) to give users
helpful information. This interactivity helps to relieve the crowding issue of
having many overlapping points in a small space.

A few baseball-related takeaways:

- Peter Moylan's sinker stands out as the most unique pitch on the plot, likely
due to his atypical sidearm / submarine delivery. Josh Collmenter's cutter
also stands out (to a lesser degree) for positive vertical movement, likely due
to his exaggerated overhead delivery
- A few pitchers that helped me to spot the issue with our Pythagorean movement
definition for 2-seam fastballs and sinkers include Jonny Venters, Dallas Keuchel,
Julio Teheran, and Mike Soroka. These pitchers are / were known to have above 
average pitches in these categories, and it surprised me to see their names 
omitted from an originally filtered plot
- Cutters appear to have the least horizontal movement of all of the fastball-type
pitches, which is doubly interesting because it is the only pitch with glove-side
movement. It's unclear to me whether the small magnitude of horizontal movement
is due to (1) the manner in which Statcast data is measured (i.e., some kind of
offset or bias toward arm-side movement), (2) the natural tendency of fastballs
to move toward the arm-side, (3) some combination of the above or something else
entirely!

** Note: This plot provides some insight into the relationship between fastball
velocity and movement (through the size aesthetic), but I'm not seeing a clear
trend pop off of the page. A future investigation into this relationship (with
some different plots and calculations) could be interesting, but I'll move on 
now to cover additional topics.

#### Off-speed pitches

&nbsp;

EDA wish list:

- Movement of pitches
- Most effective pitches in terms of outcomes
- Pitches that are mostly likely to be strikes, balls, taken, swung at
- Pitch velocity over time for pitchers (during game, during season, year-to-year)
- Umpire accuracy by pitcher, by point in game (e.g., inning, runners on)

Visualization wish list:

- Plot the trajectory of a pitch
- Mock-up a strike-zone and have pitches come (like MLB Gameday)

Modeling wish list:

- Pitch classification algorithm
- Predict which pitch will be thrown in certain situations
