---
title: "Atlanta Braves Pitching Analysis"
author: "Rob Kravec"
date: "12/14/2020"
output: html_document
---

```{r setup, include=FALSE}
# Set global chunk options
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)

# Load libraries
library(tidyverse)
library(vroom)
library(patchwork)
library(ggrepel)
library(ggiraph)
library(htmlwidgets)
```

## Introduction

Read in Statcast data for Braves pitchers from 2017-2020 (including playoffs)

```{r read-merge-data}
# Create function to read in data. Several columns had data types changed in 
# 2020, so we manually assign the data type of our choosing for those columns
read_braves <- function(year) {
  file_name <- paste0("data/Braves_", year, ".csv")
  pitch_data <- vroom(file_name,
                      col_types = c(release_spin_rate = "d",
                                    release_speed = "d",
                                    release_pos_x = "d",
                                    release_pos_y = "d",
                                    release_pos_z = "d",
                                    zone = "d",
                                    pfx_x = "d",
                                    pfx_z = "d",
                                    plate_x = "d",
                                    plate_z = "d",
                                    fielder_2 = "c", fielder_3 = "c",
                                    fielder_4 = "c", fielder_5 = "c",
                                    fielder_6 = "c", fielder_7 = "c",
                                    fielder_8 = "c", fielder_9 = "c",
                                    vx0 = "d", vy0 = "d", vz0 = "d",
                                    ax = "d", ay = "d", az = "d",
                                    sz_top = "d", sz_bot = "d",
                                    effective_speed = "d",
                                    release_extension = "d"
                                    )
                      )
  return(pitch_data)
}

# Read in 2017-2020 data using function
braves_pitch <- map_df(.x = 2017:2020, .f = read_braves)

# Look at summary of output
glimpse(braves_pitch)

# Based on this summary and the glossary, remove deprecated field
braves_pitch <- braves_pitch %>% 
  select(-c(spin_dir, spin_rate_deprecated, break_angle_deprecated, 
            break_length_deprecated, tfs_deprecated, tfs_zulu_deprecated,
            umpire))

# Remove duplicate columns for pitcher and catcher ids
braves_pitch <- braves_pitch %>% 
  select(-c(pitcher...8, fielder_2...42)) %>% 
  rename(pitcher = pitcher...60, fielder_2 = fielder_2...61)
```

The purpose of this project is to ask and answer some interesting questions 
about Atlanta Braves pitching from 2017-2020. We don't have a set agenda per se.
Rather, the project is a success if we uncover some previously unknown insights
and find compelling ways to present them.

*Why the Atlanta Braves?* I wanted to keep the amount of data manageable, so
I elected to focus on my favorite team
*Why 2017-2020?* There is no special significance to this time period. I wanted
to keep the amount of data manageable while still being able to look at
multiple (recent) seasons. 2017-2020 provided a reasonable solution, while
also ensuring that all velocities were measured with a single system (Statcast).
From 2008 to 2016, pitch velocities were measured via PitchF/x

## EDA

### Who threw the most pitches for the Braves in each year?

```{r 1-most-pitches}
# Create data frame that contains top 10 pitch throwers per season
top_pitches <- braves_pitch %>% 
  group_by(game_year) %>% 
  count(player_name) %>% 
  arrange(desc(n)) %>% 
  slice(1:10) %>% 
  rename(pitches = n)

# Write function to generate desired plot for the given year
plot_pitches <- function(year){
  top_pitches %>% 
    filter(game_year == year) %>% 
    ggplot(mapping = aes(x = reorder(player_name, - pitches), y = pitches)) +
    geom_bar(stat = "identity", fill = "red3") +
    labs(y = "Pitches thrown",
         title = paste0(year)) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
          panel.grid.major.x = element_blank(),
          axis.text.x = element_text(angle = 30, hjust = 1),
          axis.title.x = element_blank()) 
}

# Create individual plots required to make patchwork plot of pitch leaders
# for 2017-2020
for (i in 2017:2020) {
  plot_name <- paste0("pitch_", i)
  assign(plot_name, plot_pitches(i))
}

# Build patchwork plot
patch_plot <- (pitch_2017 + pitch_2018) / (pitch_2019 + pitch_2020)
patch_plot <- patch_plot + plot_annotation(
  title = "Atlanta Braves leaders in pitches thrown per year",
  theme = theme(plot.title = element_text(hjust = 0.5, size = 20))) 
patch_plot

# Save plot
ggsave(plot = patch_plot, path = "plots/", filename = "total_pitches.png")
```

Normally, in summarizing a pitcher's work for a given season, we tend to think
about inning totals, not pitch totals. We opted for pitch totals here due to the
unique nature of the Statcast data, and I think the results are pretty 
interesting! 

- The turnover on the Braves' pitching staff year-to-year is quite significant!
Of course, we would need to contextualize (relative to other teams) before 
making any meaningful statements about turnover being more or less than average
- We see clear evidence of the Braves' proclivity for bringing in veteran 
pitchers on short contracts: R.A. Dickey, Jaime Garcia, and Bartolo Colon in 
2017, Anibal Sanchez in 2018, Dallas Keuchel in 2019. Cole Hamels is noticeably
absent from the 2020 plot after a shoulder injury (essentially wasting his $18M
one year contract)
- 2020 was a weird season! Likely due to their prominence in the playoffs, Ian
Anderson and Kyle Wright make the top 3 pitch throwers for the Braves. After
those two and Max Fried, we see a slew of relievers. Chris Martin and Mark 
Melancon (two of the highest leverage arms in the bullpen) threw about 400
pitches each and just missed appearing in the 2020 plot

From here, we'll try to leverage the Statcast data for its strengths: individual
pitch-level insights. While it was fun to look at pitch totals across seasons,
summary statistics (which we could easily find elsewhere) would probably provide
more intuitive and meaningful insights.

### Among the most common pitch types, which pitchers have the most pitch movement?

#### Fastballs


```{r 2-movement-fastballs}
# Prepare dataset
fastballs <- braves_pitch %>% 
  filter(pitch_name %in% c("2-Seam Fastball", "4-Seam Fastball",
                           "Cutter", "Sinker")) %>% 
  group_by(player_name, pitch_name, p_throws) %>% 
  summarise(cnt = n(),
            x_move = median(pfx_x), # Reduce influence of extreme cases with median
            z_move = median(pfx_z),
            velo = median(release_speed)) %>% 
  filter(cnt >= 50) %>% # Remove pitcher / pitch combos with fewer than 50 occurrences
  ungroup() %>% 
  mutate(x_move_mod = ifelse(p_throws == "L", -x_move, x_move),
         x_move_abs = abs(x_move), # Corrects for difference in L vs. R hand pitchers
         total_move = sqrt(x_move ^ 2 + z_move ^ 2) # Define Pythagorean tot movement
         ) %>%  
  group_by(pitch_name) %>% 
  arrange(pitch_name, desc(total_move)) #%>% 
  #slice(1:10)
# Ultimately decided not to filter by total movement for fastballs because vertical
# movement is tricky for fastballs. While it is generally accepted as a positive
# attribute for 4-seam fastballs, the same cannot be said for 2-seam fastballs, 
# cutters, and sinkers. In fact, lower values of vertical movement for 
# 2-seam fastballs and sinkers is likely desirable (e.g., a rising sinker is bad)

# Generate interactive scatterplot using ggirafe
fastball_plot <- ggplot(data = fastballs, 
       mapping = aes(x = x_move_mod, y = z_move)) +
  geom_jitter_interactive(mapping = aes(size = velo,
                                       tooltip = paste0("Player: ", player_name, 
                                                        "\n Avg velo: ",
                                                        round(velo, 1), " MPH"))
                         , color = "red3") +
  labs(x = "Horizontal movement [ft]",
       y = "Vertical movement [ft]",
       title = "Movement of fastball-type pitches",
       size = "Velocity [mph]") +
  facet_wrap(~pitch_name) +
  scale_size_continuous(range = c(0.5, 1.5)) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) 

# Display plot and save as .html file 
fastball_plot_interactive <- girafe(code = print(fastball_plot))
fastball_plot_interactive
withr::with_dir('plots', saveWidget(fastball_plot_interactive,
                                    file="fastball_movement.html"))
# Last command is necessary to save plot into "plots/" directory. saveWidget
# has an issue with relative paths
```

This exercise gave some good practice with interactive plotting and showed the
importance of using intuition during the EDA process. At first, it seemed like
a good idea to use a Pythagorean definition of total movement (i.e., sqrt of
sum of squared x and z movement components) to select pitchers with better
than average movement on their pitches. However, upon reviewing the resulting
filtered scatterplots, it became apparent that something was wrong (due to the
absence of expected names): Some pitches (namely 2-seam fastballs and sinkers)
are actually better if they have less positive z-directional movement. 

To combat this issue, I decided to include all pitchers who threw at least 50
of that pitch type and use interactive points (through ggirafe) to give users
helpful information. This interactivity helps to relieve the crowding issue of
having many overlapping points in a small space.

A few baseball-related takeaways:

- Peter Moylan's sinker stands out as the most unique pitch on the plot, likely
due to his atypical sidearm / submarine delivery. Josh Collmenter's cutter
also stands out (to a lesser degree) for positive vertical movement, likely due
to his exaggerated overhead delivery
- A few pitchers that helped me to spot the issue with our Pythagorean movement
definition for 2-seam fastballs and sinkers include Jonny Venters, Dallas Keuchel,
Julio Teheran, and Mike Soroka. These pitchers are / were known to have above 
average pitches in these categories, and it surprised me to see their names 
omitted from an originally filtered plot
- Cutters appear to have the least horizontal movement of all of the fastball-type
pitches, which is doubly interesting because it is the only pitch with glove-side
movement. It's unclear to me whether the small magnitude of horizontal movement
is due to (1) the manner in which Statcast data is measured (i.e., some kind of
offset or bias toward arm-side movement), (2) the natural tendency of fastballs
to move toward the arm-side, (3) some combination of the above or something else
entirely!

** Note: This plot provides some insight into the relationship between fastball
velocity and movement (through the size aesthetic), but I'm not seeing a clear
trend pop off of the page. A future investigation into this relationship (with
some different plots and calculations) could be interesting, but I'll move on 
now to cover additional topics.

#### Off-speed pitches


To determine which off-speed pitches to focus on, let's see how many pitchers 
threw at least 50 of each pitch.

```{r pitch-counts}
braves_pitch %>% 
  count(player_name, pitch_name) %>% 
  filter(n >= 50) %>% 
  count(pitch_name) %>% 
  arrange(desc(n))
```

From this result, it is pretty safe to say that we can focus on sliders, 
changeups, and curveballs in this section.

To differentiate slightly from the previous section on fastball-type
pitch movement, we'll find the percentage of pitches for each pitcher that
are sliders, changeups, and curveballs. This information can then be conveyed 
through the size aesthetic (instead of velocity).

```{r pitch-percentages}
# Compute total number of pitches thrown by each Braves pitcher
total_pitches <- braves_pitch %>% 
  count(player_name) %>% 
  arrange(desc(n))

# Create data frame corresponding to off-speed pitches of interest
offspeed <- braves_pitch %>% 
  group_by(player_name, pitch_name, p_throws) %>% 
  summarise(cnt = n(),
            x_move = median(pfx_x), # Reduce influence of extreme cases with median
            z_move = median(pfx_z),
            velo = median(release_speed)
            ) %>% 
  filter(cnt >= 50, pitch_name %in% c("Slider", "Changeup", "Curveball")) %>% 
  ungroup() %>% 
  # Correct for difference in L vs. R hand pitchers
  mutate(x_move_mod = ifelse(p_throws == "L", -x_move, x_move)) 

# Join total_pitches data frame to offspeed
offspeed_join <- left_join(x = offspeed, y = total_pitches,
                           by = c("player_name"))

# Create additional column corresponding to % of total pitches thrown
offspeed_join <- offspeed_join %>% 
  mutate(perc = 100 * round(cnt / n, 3))

# Generate interactive plot  
offspeed_plot <- ggplot(data = offspeed_join, 
       mapping = aes(x = x_move_mod, y = z_move)) +
  geom_jitter_interactive(mapping = aes(size = perc,
                                       tooltip = paste0("Player: ", player_name, 
                                                        "\n Avg velo: ",
                                                        round(velo, 1), " MPH",
                                                        "\n % of total pitches: ",
                                                        perc, "%")), 
                          color = "red3") +
  labs(x = "Horizontal movement [ft]",
       y = "Vertical movement [ft]",
       title = "Movement of offspeed pitches",
       size = "% total pitches") +
  facet_wrap(~pitch_name, dir = "v") +
  scale_size_continuous(range = c(0.5, 1.5)) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) 

# Display plot and save as .html file 
offspeed_plot_interactive <- girafe(code = print(offspeed_plot))
offspeed_plot_interactive
withr::with_dir('plots', saveWidget(offspeed_plot_interactive,
                                    file="offspeed_movement.html"))
```

A few things that stand out to me (more for fun than meaningful insight):

- Josh Collmenter again stands out for exceptional rise, this time on his 
changeup, which he throws about 30% of the time
- I now understand (at least part of) why hitters look so silly against Chris
Martin's and Shane Greene's slider. These pitches have a ton of horizontal 
movement!
- It's comforting to see that Max Fried's curveball has the most vertical drop
of any offspeed pitch considered. I did not expect, however, that Sean Newcomb, 
Robbie Erlin, and Jesse Biddle would have curveballs that come next on that list.
I would consider these data points to be a great illustration that "stuff" 
isn't everything

### How often do umpires make the right ball / strike calls? Are certain pitchers  more prone to inaccurate calls?

To start with, we'll have to define an "objective strike zone" based on the 
Statcast data. I'll propose the following rules /assumptions (based mostly on 
trial and error with plotted results):

- The width (horizontal dimension) of the strike zone is equal to the width of
home plate (17 inches)
- The height (vertical dimension) of the strike zone is appropriately described
by the `sz_top` and `sz_bot` fields
- The `plate_x` and `plate_z` fields are defined based on the center of the
baseball at the time it crosses home plate
- A regulation baseball has a diameter of 3 inches
- For a pitch to be called a strike, the baseball must at least touch the edge
of the strike zone

Based on these rules / assumptions, we create an indicator to see whether a pitch
should have been marked as a ball or a strike. Then, we can compare the true 
outcome to our expected outcome.

```{r code-strikes}
# Visualize coordinates for each Statcast zone (just to make sure I'm
# understanding the coordinate system properly)
coord_system <- ggplot(data = braves_pitch, 
       mapping = aes(x = plate_x, y = plate_z, color = as.factor(zone))) +
  geom_point() +
  labs(x = "x-position", y = "z-position", 
       title = "Visualizing coordinate system",
       color = "Zone",
       caption = "We can conclude that the horizontal axis is centered at 0") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
        plot.caption = element_text(hjust = 0.5)) +
  lims(x = c(-3, 3), y = c(-1, 6)) 
coord_system

# The plot turned out to be quite aesthetically pleasing, so I'll save it
ggsave(plot = coord_system, path = "plots/", filename = "coord_system.png")

# Create expected ball / strike indicator
ball_rad <- 1.5 / 12 # Baseball radius in feet
plate_width <- 17 / 12 # Width of front of plate in feet
braves_pitch <- braves_pitch %>% 
  mutate(exp_call = case_when(
    type == "X" ~ "X", # If ball is put in play, we don't call it ball or strike
    abs(plate_x) > plate_width / 2 + ball_rad ~ "B", # Pitch is inside or outside
    plate_z > sz_top + ball_rad ~ "B", # Pitch is high
    plate_z < sz_bot - ball_rad ~ "B", # Pitch is low
    TRUE ~ "S" # All other pitches should be called a strike
  ))

### Quick visualization of our expected ball and strike calls vs. reality:
### For this visualization, it would be best to plot the strikes on top of the 
### balls to see the extent of the true strike zone

# Create data frame with only balls and called strikes
taken_pitches <- braves_pitch %>% 
  filter(description %in% c("ball", "called_strike"))
  
# Step 1: Plot of expected calls
expected_call_plot <- ggplot() +
  geom_point(subset(taken_pitches, exp_call == "B"),
             mapping = aes(x = plate_x, y = plate_z, color = "B")) +
  geom_point(subset(taken_pitches, exp_call == "S"),
             mapping = aes(x = plate_x, y = plate_z, color = "S")) +
  labs(x = "x-position", y = "z-position", 
       title = "Expected ball / strike calls",
       color = "Expected call") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  lims(x = c(-3, 3), y = c(-1, 6)) 

# Step 2: Plot of actual calls
actual_call_plot <- ggplot() +
  geom_point(subset(taken_pitches, type == "B"),
             mapping = aes(x = plate_x, y = plate_z, color = "B")) +
  geom_point(subset(taken_pitches, type == "S"),
             mapping = aes(x = plate_x, y = plate_z, color = "S")) +
  labs(x = "x-position", y = "z-position", 
       title = "Actual ball / strike calls",
       color = "Actual call") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5)) +
  lims(x = c(-3, 3), y = c(-1, 6)) 

# Step 3: Patchwork combination of two plots above
strikezone_compare <- expected_call_plot + actual_call_plot

# Save plot
ggsave(plot = strikezone_compare, path = "plots/", 
       filename = "strikezone_compare.png")
```

From this comparison plot, we can see that:

- Our "objective" strike zone may be a bit narrower than the one that most 
umpires enforce. A strike heat map would do a better job showing how often
pitches on the horizontal fringes of the strike zone are called strikes
- The actual strike zone follows more of an oval than a rectangle, suggesting
that umpires will allow pitches to push the bounds in one direction (but not
both at the same time)

From here, we can compare our expected ball / strike call with the actual call
in a more quantitative manner

```{r compare-expected-to-actual}
# Add column to denote whether expected call agrees with actual call
taken_pitches <- taken_pitches %>%
  relocate(type, .after = of_fielding_alignment) %>% 
  mutate(correct_call = ifelse(type == exp_call, 1, 0)) 

# How often is the expected call made?
mean(taken_pitches$correct_call) 

# In which direction is there more likely to be a discrepancy?
mean(subset(taken_pitches, exp_call == "B")$correct_call) # We expect B, called B
mean(subset(taken_pitches, exp_call == "S")$correct_call) # We expect S, called S
mean(subset(taken_pitches, type == "B")$correct_call) # Called B, expect B
mean(subset(taken_pitches, type == "S")$correct_call) # Called S, expect S

# Plot discrepancies
taken_pitches %>% 
  filter(correct_call == 0) %>% 
  ggplot(mapping = aes(x = plate_x, y = plate_z)) + geom_point() +
  theme_bw() +
  labs(x = "x-position", y = "z-position",
       title = "Pitch call discrepancies") +
  theme(plot.title = element_text(hjust = 0.5)) +
  lims(x = c(-3, 3), y = c(-1, 6)) 
```

We observe 90% agreement between our proposed strike zone and actual ball / 
strike calls. The highest incidence of disagreement occurs on pitches that
are called strikes in reality (of which we expect 18% to be called balls). 

From here, we could look at whether a number of different factors (e.g., count,
batter handedness, pitcher handedness, score, runners on base) affect the size
of the strike zone. For example, I found a 2012 Fangraphs 
[article](https://blogs.fangraphs.com/the-size-of-the-strike-zone-by-count/) 
that measures the area of the strike zone by count and batter handedness.

Instead, we'll pump the breaks here and recognize that strike zones are quite
complex and could easily be the subject of their own, dedicated project. For 
the sake of continuing to investigate different attributes of this data set,
we quickly check to see if there is a noticeable trend for Braves pitchers 
related to the percentage of "missed calls" Sadly, nothing in particular stands
out to me (other the large spread in incidence of these "missed calls"), and I'd
like to give this topic more time and attention down the road.

```{r miss-rates-by-pitcher}
# Create indicator of different miss types
taken_pitches <- taken_pitches %>% 
  mutate(disagree_called_ball = ifelse(correct_call == 0 & type == "B", 1, 0),
         disagree_called_strike = ifelse(correct_call == 0 & type == "S", 1, 0),
         ball = ifelse(type == "B", 1, 0),
         strike = ifelse(type == "S", 1, 0)
         )

# Summarise results by pitcher
miss_summary <- taken_pitches %>% 
  group_by(player_name) %>% 
  summarise(pitches = n(),
            strikes = sum(strike),
            balls = sum(ball),
            miss_call = 1 - mean(correct_call),
            miss_called_ball = sum(disagree_called_ball),
            miss_called_strike = sum(disagree_called_strike)
            ) %>% 
  mutate(stolen_strike_perc = miss_called_strike / strikes,
         unwarranted_ball = miss_called_ball / balls,
         delta = miss_called_strike / strikes - miss_called_ball / balls) %>% 
  filter(pitches >= 100, strikes >= 50) %>% 
  arrange(desc(miss_call))
```

### How effectively can a simple model classify pitches for a single pitcher? To what extent does performance degree for multiple pitchers?

[](https://technology.mlblogs.com/mlb-pitch-classification-64a1e32ee079)

EDA wish list:

- Most effective pitches in terms of outcomes
- Pitches that are mostly likely to be strikes, balls, taken, swung at
- Pitch velocity over time for pitchers (during game, during season, year-to-year)
- In-depth scouting report on particular pitcher(s) of interest

Visualization wish list:

- Plot the trajectory of a pitch
- Mock-up a strike-zone and have pitches come (like MLB Gameday)

Modeling wish list:

- Pitch classification algorithm (for specific pitcher?)
- Predict which pitch will be thrown in certain situations
